# CI scripts

This directory contains Python scripts based on 
[ghapi](https://ghapi.fast.ai/) library.

To be able to run and debug Python scripts locally,
perform following steps:

First, create a separate private GitHub repo you will experiment with.
It is needed so that you can freely use your personal token
and perform any changes that can potentially break someone else's
flow.  Ensure to include only contents required for testing to the repo.

Clone the repo locally.

Install [ghapi](https://ghapi.fast.ai/): `pip install ghapi`.
(consider creating a virtualenv first, or use python-poetry).

Get your [GitHub personal access token](https://github.com/settings/tokens/new).
Select `repo` for the scope.

You will need to set following environment variables, and provide them
to the script:

- `GITHUB_TOKEN` - to your personal access token retrieved on a previous step.
- `GITHUB_REPOSITORY` - to your forked repo name.
- `CONTEXT_GITHUB` - to a JSON of github context.
  You may copy it from an output of a job that has
  `CONTEXT_GITHUB: ${{ toJson(github) }}` in its `env` section.


Also, if you store `CONTEXT_GITHUB` in a file, you can populate the
environment variable with a command `CONTEXT_GITHUB=$(<context_github.json)`.

Consider storing the environment variables in `.env` file,
with contents like this:

```shell
GITHUB_TOKEN=<your token>
GITHUB_REPOSITORY=username/reponame
CONTEXT_GITHUB={"job": "release", "ref": "refs/pull/28/merge", "sha": "ee18563422ad01cab610076b7ec29c9a44275dbf", "repository": "username/reponame", "repository_owner": "username", "repositoryUrl": "git://github.com/username/reponame.git", "run_id": "676237630", "run_number": "67", "retention_days": "90", "actor": "username", "workflow": "Release", "head_ref": "h", "base_ref": "master", "event_name": "pull_request", "event": {"action": "synchronize", "after": "c09e8d8e0c2f666ca5ad69266de412dd01cd810b", "before": "664181a3c289be0a8089f6c06e3464c41d34d4f8", "number": 28, "pull_request": {"_links": {"comments": {"href": "https://api.github.com/repos/username/reponame/issues/28/comments"}, "commits": {"href": "https://api.github.com/repos/username/reponame/pulls/28/commits"}, "html": {"href": "https://github.com/username/reponame/pull/28"}, "issue": {"href": "https://api.github.com/repos/username/reponame/issues/28"}, "review_comment": {"href": "https://api.github.com/repos/username/reponame/pulls/comments{/number}"}, "review_comments": {"href": "https://api.github.com/repos/username/reponame/pulls/28/comments"}, "self": {"href": "https://api.github.com/repos/username/reponame/pulls/28"}, "statuses": {"href": "https://api.github.com/repos/username/reponame/statuses/c09e8d8e0c2f666ca5ad69266de412dd01cd810b"}}, "active_lock_reason": null, "additions": 1, "assignee": null, "assignees": [], "author_association": "COLLABORATOR", "auto_merge": null, "base": {"label": "username:master", "ref": "master", "repo": {"allow_merge_commit": false, "allow_rebase_merge": true, "allow_squash_merge": true, "archive_url": "https://api.github.com/repos/username/reponame/{archive_format}{/ref}", "archived": false, "assignees_url": "https://api.github.com/repos/username/reponame/assignees{/user}", "blobs_url": "https://api.github.com/repos/username/reponame/git/blobs{/sha}", "branches_url": "https://api.github.com/repos/username/reponame/branches{/branch}", "clone_url": "https://github.com/username/reponame.git", "collaborators_url": "https://api.github.com/repos/username/reponame/collaborators{/collaborator}", "comments_url": "https://api.github.com/repos/username/reponame/comments{/number}", "commits_url": "https://api.github.com/repos/username/reponame/commits{/sha}", "compare_url": "https://api.github.com/repos/username/reponame/compare/{base}...{head}", "contents_url": "https://api.github.com/repos/username/reponame/contents/{+path}", "contributors_url": "https://api.github.com/repos/username/reponame/contributors", "created_at": "2021-03-17T10:22:21Z", "default_branch": "master", "delete_branch_on_merge": false, "deployments_url": "https://api.github.com/repos/username/reponame/deployments", "description": null, "disabled": false, "downloads_url": "https://api.github.com/repos/username/reponame/downloads", "events_url": "https://api.github.com/repos/username/reponame/events", "fork": true, "forks": 0, "forks_count": 0, "forks_url": "https://api.github.com/repos/username/reponame/forks", "full_name": "username/reponame", "git_commits_url": "https://api.github.com/repos/username/reponame/git/commits{/sha}", "git_refs_url": "https://api.github.com/repos/username/reponame/git/refs{/sha}", "git_tags_url": "https://api.github.com/repos/username/reponame/git/tags{/sha}", "git_url": "git://github.com/username/reponame.git", "has_downloads": true, "has_issues": false, "has_pages": false, "has_projects": true, "has_wiki": false, "homepage": null, "hooks_url": "https://api.github.com/repos/username/reponame/hooks", "html_url": "https://github.com/username/reponame", "id": 348666275, "issue_comment_url": "https://api.github.com/repos/username/reponame/issues/comments{/number}", "issue_events_url": "https://api.github.com/repos/username/reponame/issues/events{/number}", "issues_url": "https://api.github.com/repos/username/reponame/issues{/number}", "keys_url": "https://api.github.com/repos/username/reponame/keys{/key_id}", "labels_url": "https://api.github.com/repos/username/reponame/labels{/name}", "language": "Python", "languages_url": "https://api.github.com/repos/username/reponame/languages", "license": {"key": "gpl-3.0", "name": "GNU General Public License v3.0", "node_id": "MDc6TGljZW5zZTk=", "spdx_id": "GPL-3.0", "url": "https://api.github.com/licenses/gpl-3.0"}, "merges_url": "https://api.github.com/repos/username/reponame/merges", "milestones_url": "https://api.github.com/repos/username/reponame/milestones{/number}", "mirror_url": null, "name": "reponame", "node_id": "MDEwOlJlcG9zaXRvcnkzNDg2NjYyNzU=", "notifications_url": "https://api.github.com/repos/username/reponame/notifications{?since,all,participating}", "open_issues": 1, "open_issues_count": 1, "owner": {"avatar_url": "https://avatars.githubusercontent.com/u/2283679?v=4", "events_url": "https://api.github.com/users/username/events{/privacy}", "followers_url": "https://api.github.com/users/username/followers", "following_url": "https://api.github.com/users/username/following{/other_user}", "gists_url": "https://api.github.com/users/username/gists{/gist_id}", "gravatar_id": "", "html_url": "https://github.com/username", "id": 2283679, "login": "username", "node_id": "MDQ6VXNlcjIyODM2Nzk=", "organizations_url": "https://api.github.com/users/username/orgs", "received_events_url": "https://api.github.com/users/username/received_events", "repos_url": "https://api.github.com/users/username/repos", "site_admin": false, "starred_url": "https://api.github.com/users/username/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/username/subscriptions", "type": "User", "url": "https://api.github.com/users/username"}, "private": true, "pulls_url": "https://api.github.com/repos/username/reponame/pulls{/number}", "pushed_at": "2021-03-22T13:49:03Z", "releases_url": "https://api.github.com/repos/username/reponame/releases{/id}", "size": 437, "ssh_url": "git@github.com:username/reponame.git", "stargazers_count": 0, "stargazers_url": "https://api.github.com/repos/username/reponame/stargazers", "statuses_url": "https://api.github.com/repos/username/reponame/statuses/{sha}", "subscribers_url": "https://api.github.com/repos/username/reponame/subscribers", "subscription_url": "https://api.github.com/repos/username/reponame/subscription", "svn_url": "https://github.com/username/reponame", "tags_url": "https://api.github.com/repos/username/reponame/tags", "teams_url": "https://api.github.com/repos/username/reponame/teams", "trees_url": "https://api.github.com/repos/username/reponame/git/trees{/sha}", "updated_at": "2021-03-22T13:44:18Z", "url": "https://api.github.com/repos/username/reponame", "watchers": 0, "watchers_count": 0}, "sha": "3a545a9e61f83bfdb6766614bb4636c4ccf46b3a", "user": {"avatar_url": "https://avatars.githubusercontent.com/u/2283679?v=4", "events_url": "https://api.github.com/users/username/events{/privacy}", "followers_url": "https://api.github.com/users/username/followers", "following_url": "https://api.github.com/users/username/following{/other_user}", "gists_url": "https://api.github.com/users/username/gists{/gist_id}", "gravatar_id": "", "html_url": "https://github.com/username", "id": 2283679, "login": "username", "node_id": "MDQ6VXNlcjIyODM2Nzk=", "organizations_url": "https://api.github.com/users/username/orgs", "received_events_url": "https://api.github.com/users/username/received_events", "repos_url": "https://api.github.com/users/username/repos", "site_admin": false, "starred_url": "https://api.github.com/users/username/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/username/subscriptions", "type": "User", "url": "https://api.github.com/users/username"}}, "body": "", "changed_files": 1, "closed_at": null, "comments": 0, "comments_url": "https://api.github.com/repos/username/reponame/issues/28/comments", "commits": 2, "commits_url": "https://api.github.com/repos/username/reponame/pulls/28/commits", "created_at": "2021-03-22T13:43:07Z", "deletions": 0, "diff_url": "https://github.com/username/reponame/pull/28.diff", "draft": false, "head": {"label": "username:h", "ref": "h", "repo": {"allow_merge_commit": false, "allow_rebase_merge": true, "allow_squash_merge": true, "archive_url": "https://api.github.com/repos/username/reponame/{archive_format}{/ref}", "archived": false, "assignees_url": "https://api.github.com/repos/username/reponame/assignees{/user}", "blobs_url": "https://api.github.com/repos/username/reponame/git/blobs{/sha}", "branches_url": "https://api.github.com/repos/username/reponame/branches{/branch}", "clone_url": "https://github.com/username/reponame.git", "collaborators_url": "https://api.github.com/repos/username/reponame/collaborators{/collaborator}", "comments_url": "https://api.github.com/repos/username/reponame/comments{/number}", "commits_url": "https://api.github.com/repos/username/reponame/commits{/sha}", "compare_url": "https://api.github.com/repos/username/reponame/compare/{base}...{head}", "contents_url": "https://api.github.com/repos/username/reponame/contents/{+path}", "contributors_url": "https://api.github.com/repos/username/reponame/contributors", "created_at": "2021-03-17T10:22:21Z", "default_branch": "master", "delete_branch_on_merge": false, "deployments_url": "https://api.github.com/repos/username/reponame/deployments", "description": null, "disabled": false, "downloads_url": "https://api.github.com/repos/username/reponame/downloads", "events_url": "https://api.github.com/repos/username/reponame/events", "fork": true, "forks": 0, "forks_count": 0, "forks_url": "https://api.github.com/repos/username/reponame/forks", "full_name": "username/reponame", "git_commits_url": "https://api.github.com/repos/username/reponame/git/commits{/sha}", "git_refs_url": "https://api.github.com/repos/username/reponame/git/refs{/sha}", "git_tags_url": "https://api.github.com/repos/username/reponame/git/tags{/sha}", "git_url": "git://github.com/username/reponame.git", "has_downloads": true, "has_issues": false, "has_pages": false, "has_projects": true, "has_wiki": false, "homepage": null, "hooks_url": "https://api.github.com/repos/username/reponame/hooks", "html_url": "https://github.com/username/reponame", "id": 348666275, "issue_comment_url": "https://api.github.com/repos/username/reponame/issues/comments{/number}", "issue_events_url": "https://api.github.com/repos/username/reponame/issues/events{/number}", "issues_url": "https://api.github.com/repos/username/reponame/issues{/number}", "keys_url": "https://api.github.com/repos/username/reponame/keys{/key_id}", "labels_url": "https://api.github.com/repos/username/reponame/labels{/name}", "language": "Python", "languages_url": "https://api.github.com/repos/username/reponame/languages", "license": {"key": "gpl-3.0", "name": "GNU General Public License v3.0", "node_id": "MDc6TGljZW5zZTk=", "spdx_id": "GPL-3.0", "url": "https://api.github.com/licenses/gpl-3.0"}, "merges_url": "https://api.github.com/repos/username/reponame/merges", "milestones_url": "https://api.github.com/repos/username/reponame/milestones{/number}", "mirror_url": null, "name": "reponame", "node_id": "MDEwOlJlcG9zaXRvcnkzNDg2NjYyNzU=", "notifications_url": "https://api.github.com/repos/username/reponame/notifications{?since,all,participating}", "open_issues": 1, "open_issues_count": 1, "owner": {"avatar_url": "https://avatars.githubusercontent.com/u/2283679?v=4", "events_url": "https://api.github.com/users/username/events{/privacy}", "followers_url": "https://api.github.com/users/username/followers", "following_url": "https://api.github.com/users/username/following{/other_user}", "gists_url": "https://api.github.com/users/username/gists{/gist_id}", "gravatar_id": "", "html_url": "https://github.com/username", "id": 2283679, "login": "username", "node_id": "MDQ6VXNlcjIyODM2Nzk=", "organizations_url": "https://api.github.com/users/username/orgs", "received_events_url": "https://api.github.com/users/username/received_events", "repos_url": "https://api.github.com/users/username/repos", "site_admin": false, "starred_url": "https://api.github.com/users/username/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/username/subscriptions", "type": "User", "url": "https://api.github.com/users/username"}, "private": true, "pulls_url": "https://api.github.com/repos/username/reponame/pulls{/number}", "pushed_at": "2021-03-22T13:49:03Z", "releases_url": "https://api.github.com/repos/username/reponame/releases{/id}", "size": 437, "ssh_url": "git@github.com:username/reponame.git", "stargazers_count": 0, "stargazers_url": "https://api.github.com/repos/username/reponame/stargazers", "statuses_url": "https://api.github.com/repos/username/reponame/statuses/{sha}", "subscribers_url": "https://api.github.com/repos/username/reponame/subscribers", "subscription_url": "https://api.github.com/repos/username/reponame/subscription", "svn_url": "https://github.com/username/reponame", "tags_url": "https://api.github.com/repos/username/reponame/tags", "teams_url": "https://api.github.com/repos/username/reponame/teams", "trees_url": "https://api.github.com/repos/username/reponame/git/trees{/sha}", "updated_at": "2021-03-22T13:44:18Z", "url": "https://api.github.com/repos/username/reponame", "watchers": 0, "watchers_count": 0}, "sha": "c09e8d8e0c2f666ca5ad69266de412dd01cd810b", "user": {"avatar_url": "https://avatars.githubusercontent.com/u/2283679?v=4", "events_url": "https://api.github.com/users/username/events{/privacy}", "followers_url": "https://api.github.com/users/username/followers", "following_url": "https://api.github.com/users/username/following{/other_user}", "gists_url": "https://api.github.com/users/username/gists{/gist_id}", "gravatar_id": "", "html_url": "https://github.com/username", "id": 2283679, "login": "username", "node_id": "MDQ6VXNlcjIyODM2Nzk=", "organizations_url": "https://api.github.com/users/username/orgs", "received_events_url": "https://api.github.com/users/username/received_events", "repos_url": "https://api.github.com/users/username/repos", "site_admin": false, "starred_url": "https://api.github.com/users/username/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/username/subscriptions", "type": "User", "url": "https://api.github.com/users/username"}}, "html_url": "https://github.com/username/reponame/pull/28", "id": 598022113, "issue_url": "https://api.github.com/repos/username/reponame/issues/28", "labels": [], "locked": false, "maintainer_can_modify": false, "merge_commit_sha": "e1ca32de27e479603cea6bd0c227f53552d399a9", "mergeable": null, "mergeable_state": "unknown", "merged": false, "merged_at": null, "merged_by": null, "milestone": null, "node_id": "MDExOlB1bGxSZXF1ZXN0NTk4MDIyMTEz", "number": 28, "patch_url": "https://github.com/username/reponame/pull/28.patch", "rebaseable": null, "requested_reviewers": [], "requested_teams": [], "review_comment_url": "https://api.github.com/repos/username/reponame/pulls/comments{/number}", "review_comments": 0, "review_comments_url": "https://api.github.com/repos/username/reponame/pulls/28/comments", "state": "open", "statuses_url": "https://api.github.com/repos/username/reponame/statuses/c09e8d8e0c2f666ca5ad69266de412dd01cd810b", "title": "Minor change", "updated_at": "2021-03-22T13:49:04Z", "url": "https://api.github.com/repos/username/reponame/pulls/28", "user": {"avatar_url": "https://avatars.githubusercontent.com/u/2283679?v=4", "events_url": "https://api.github.com/users/username/events{/privacy}", "followers_url": "https://api.github.com/users/username/followers", "following_url": "https://api.github.com/users/username/following{/other_user}", "gists_url": "https://api.github.com/users/username/gists{/gist_id}", "gravatar_id": "", "html_url": "https://github.com/username", "id": 2283679, "login": "username", "node_id": "MDQ6VXNlcjIyODM2Nzk=", "organizations_url": "https://api.github.com/users/username/orgs", "received_events_url": "https://api.github.com/users/username/received_events", "repos_url": "https://api.github.com/users/username/repos", "site_admin": false, "starred_url": "https://api.github.com/users/username/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/username/subscriptions", "type": "User", "url": "https://api.github.com/users/username"}}, "repository": {"archive_url": "https://api.github.com/repos/username/reponame/{archive_format}{/ref}", "archived": false, "assignees_url": "https://api.github.com/repos/username/reponame/assignees{/user}", "blobs_url": "https://api.github.com/repos/username/reponame/git/blobs{/sha}", "branches_url": "https://api.github.com/repos/username/reponame/branches{/branch}", "clone_url": "https://github.com/username/reponame.git", "collaborators_url": "https://api.github.com/repos/username/reponame/collaborators{/collaborator}", "comments_url": "https://api.github.com/repos/username/reponame/comments{/number}", "commits_url": "https://api.github.com/repos/username/reponame/commits{/sha}", "compare_url": "https://api.github.com/repos/username/reponame/compare/{base}...{head}", "contents_url": "https://api.github.com/repos/username/reponame/contents/{+path}", "contributors_url": "https://api.github.com/repos/username/reponame/contributors", "created_at": "2021-03-17T10:22:21Z", "default_branch": "master", "deployments_url": "https://api.github.com/repos/username/reponame/deployments", "description": null, "disabled": false, "downloads_url": "https://api.github.com/repos/username/reponame/downloads", "events_url": "https://api.github.com/repos/username/reponame/events", "fork": true, "forks": 0, "forks_count": 0, "forks_url": "https://api.github.com/repos/username/reponame/forks", "full_name": "username/reponame", "git_commits_url": "https://api.github.com/repos/username/reponame/git/commits{/sha}", "git_refs_url": "https://api.github.com/repos/username/reponame/git/refs{/sha}", "git_tags_url": "https://api.github.com/repos/username/reponame/git/tags{/sha}", "git_url": "git://github.com/username/reponame.git", "has_downloads": true, "has_issues": false, "has_pages": false, "has_projects": true, "has_wiki": false, "homepage": null, "hooks_url": "https://api.github.com/repos/username/reponame/hooks", "html_url": "https://github.com/username/reponame", "id": 348666275, "issue_comment_url": "https://api.github.com/repos/username/reponame/issues/comments{/number}", "issue_events_url": "https://api.github.com/repos/username/reponame/issues/events{/number}", "issues_url": "https://api.github.com/repos/username/reponame/issues{/number}", "keys_url": "https://api.github.com/repos/username/reponame/keys{/key_id}", "labels_url": "https://api.github.com/repos/username/reponame/labels{/name}", "language": "Python", "languages_url": "https://api.github.com/repos/username/reponame/languages", "license": {"key": "gpl-3.0", "name": "GNU General Public License v3.0", "node_id": "MDc6TGljZW5zZTk=", "spdx_id": "GPL-3.0", "url": "https://api.github.com/licenses/gpl-3.0"}, "merges_url": "https://api.github.com/repos/username/reponame/merges", "milestones_url": "https://api.github.com/repos/username/reponame/milestones{/number}", "mirror_url": null, "name": "reponame", "node_id": "MDEwOlJlcG9zaXRvcnkzNDg2NjYyNzU=", "notifications_url": "https://api.github.com/repos/username/reponame/notifications{?since,all,participating}", "open_issues": 1, "open_issues_count": 1, "owner": {"avatar_url": "https://avatars.githubusercontent.com/u/2283679?v=4", "events_url": "https://api.github.com/users/username/events{/privacy}", "followers_url": "https://api.github.com/users/username/followers", "following_url": "https://api.github.com/users/username/following{/other_user}", "gists_url": "https://api.github.com/users/username/gists{/gist_id}", "gravatar_id": "", "html_url": "https://github.com/username", "id": 2283679, "login": "username", "node_id": "MDQ6VXNlcjIyODM2Nzk=", "organizations_url": "https://api.github.com/users/username/orgs", "received_events_url": "https://api.github.com/users/username/received_events", "repos_url": "https://api.github.com/users/username/repos", "site_admin": false, "starred_url": "https://api.github.com/users/username/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/username/subscriptions", "type": "User", "url": "https://api.github.com/users/username"}, "private": true, "pulls_url": "https://api.github.com/repos/username/reponame/pulls{/number}", "pushed_at": "2021-03-22T13:49:03Z", "releases_url": "https://api.github.com/repos/username/reponame/releases{/id}", "size": 437, "ssh_url": "git@github.com:username/reponame.git", "stargazers_count": 0, "stargazers_url": "https://api.github.com/repos/username/reponame/stargazers", "statuses_url": "https://api.github.com/repos/username/reponame/statuses/{sha}", "subscribers_url": "https://api.github.com/repos/username/reponame/subscribers", "subscription_url": "https://api.github.com/repos/username/reponame/subscription", "svn_url": "https://github.com/username/reponame", "tags_url": "https://api.github.com/repos/username/reponame/tags", "teams_url": "https://api.github.com/repos/username/reponame/teams", "trees_url": "https://api.github.com/repos/username/reponame/git/trees{/sha}", "updated_at": "2021-03-22T13:44:18Z", "url": "https://api.github.com/repos/username/reponame", "watchers": 0, "watchers_count": 0}, "sender": {"avatar_url": "https://avatars.githubusercontent.com/u/2283679?v=4", "events_url": "https://api.github.com/users/username/events{/privacy}", "followers_url": "https://api.github.com/users/username/followers", "following_url": "https://api.github.com/users/username/following{/other_user}", "gists_url": "https://api.github.com/users/username/gists{/gist_id}", "gravatar_id": "", "html_url": "https://github.com/username", "id": 2283679, "login": "username", "node_id": "MDQ6VXNlcjIyODM2Nzk=", "organizations_url": "https://api.github.com/users/username/orgs", "received_events_url": "https://api.github.com/users/username/received_events", "repos_url": "https://api.github.com/users/username/repos", "site_admin": false, "starred_url": "https://api.github.com/users/username/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/username/subscriptions", "type": "User", "url": "https://api.github.com/users/username"}}, "server_url": "https://github.com", "api_url": "https://api.github.com", "graphql_url": "https://api.github.com/graphql", "workspace": "/home/runner/work/reponame/reponame", "action": "run5", "event_path": "/home/runner/work/_temp/_github_workflow/event.json", "action_repository": "", "action_ref": "", "path": "/home/runner/work/_temp/_runner_file_commands/add_path_ef6a6cb0-666c-4fde-ac67-af619037b9c1", "env": "/home/runner/work/_temp/_runner_file_commands/set_env_ef6a6cb0-666c-4fde-ac67-af619037b9c1"}
```

Then run the script as following:

```shell
env $(cat .env | xargs) python ./scripts/reset_dev_branch.py
```

Or, if you have `CONTEXT_GITHUB` contents in a file:

```shell
env $(cat .env | xargs) CONTEXT_GITHUB=$(<context_github.json) python ./scripts/reset_dev_branch.py
```
